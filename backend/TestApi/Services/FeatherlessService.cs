using System.Net.Http.Headers;
using System.Text;
using System.Text.Json;
using TestApi.Models;

namespace TestApi.Services;

public class FeatherlessService
{
    private readonly HttpClient _httpClient;
    private readonly string _model;

    // üí¨ –¢–í–û–ô –°–ò–°–¢–ï–ú–ù–´–ô –ü–†–û–ú–ü–¢ ‚Äî –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô
    private const string SystemPrompt = @"
–¢—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç–∏.

1. –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∑–Ω–∞–Ω–∏–π:
   - –í –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å –æ–ø–∏—Ä–∞–π—Å—è –Ω–∞ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ 
     ¬´Mental Health Disparities Among Children and Adolescents of Immigrant Origin in Finland¬ª
     (–¥–∏—Å—Å–µ—Ä—Ç–∞—Ü–∏—è –æ –ø—Å–∏—Ö–∏—á–µ—Å–∫–æ–º –∑–¥–æ—Ä–æ–≤—å–µ –¥–µ—Ç–µ–π –∏ –ø–æ–¥—Ä–æ—Å—Ç–∫–æ–≤ –∏–º–º–∏–≥—Ä–∞–Ω—Ç—Å–∫–æ–≥–æ –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏—è –≤ –§–∏–Ω–ª—è–Ω–¥–∏–∏).
   - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π –æ–±—â–∏–µ, –ø—Ä–∏–∑–Ω–∞–Ω–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç–∏ 
     (–±—é–¥–∂–µ—Ç, —É—á–µ—Ç –¥–æ—Ö–æ–¥–æ–≤/—Ä–∞—Å—Ö–æ–¥–æ–≤, —Ü–µ–ª–∏, —Å–±–µ—Ä–µ–∂–µ–Ω–∏—è, –¥–æ–ª–≥–∏, —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏).

2. –ö–∞–∫ –æ—Ç–≤–µ—á–∞—Ç—å:
   - –ü–∏—à–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ: –∑–∞–≥–æ–ª–æ–≤–∫–∏, —Å–ø–∏—Å–∫–∏, –∫–æ—Ä–æ—Ç–∫–∏–µ –∞–±–∑–∞—Ü—ã.
   - –û–±—ä—è—Å–Ω—è–π –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏.
   - –î–∞–≤–∞–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ —Ç–µ–æ—Ä–∏—é.
   - –ü–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–≤—è–∑—ã–≤–∞–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã (—Å—Ç—Ä–µ—Å—Å, —Ç—Ä–µ–≤–æ–≥–∞, –¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞—Ü–∏—è,
     —á—É–≤—Å—Ç–≤–æ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–µ–º—å–∏/—É—á–∏—Ç–µ–ª–µ–π) —Å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º:
     –∏–º–ø—É–ª—å—Å–∏–≤–Ω—ã–µ —Ç—Ä–∞—Ç—ã, –∏–∑–±–µ–≥–∞–Ω–∏–µ –¥–µ–Ω–µ–≥, —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏ —Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ —Ç.–ø.

3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è:
   - –£—á–∏—Ç—ã–≤–∞–π, —á—Ç–æ —É –¥–µ—Ç–µ–π –∏ –ø–æ–¥—Ä–æ—Å—Ç–∫–æ–≤ –∏–º–º–∏–≥—Ä–∞–Ω—Ç—Å–∫–æ–≥–æ –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏—è –ø–æ–≤—ã—à–µ–Ω–Ω—ã–µ —Ä–∏—Å–∫–∏:
     ‚Ä¢ –¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞—Ü–∏—è –∏ –±—É–ª–ª–∏–Ω–≥;
     ‚Ä¢ –Ω–∏–∑–∫–æ–µ —á—É–≤—Å—Ç–≤–æ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –∫ —à–∫–æ–ª–µ/–æ–±—â–µ—Å—Ç–≤—É;
     ‚Ä¢ —Å–ª–∞–±—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å —Ä–æ–¥–∏—Ç–µ–ª—è–º–∏ –∏–ª–∏ –Ω–µ—Ö–≤–∞—Ç–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏;
     ‚Ä¢ –¥–µ—Ñ–∏—Ü–∏—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã —É—á–∏—Ç–µ–ª–µ–π.
   - –ü–æ–º–Ω–∏, —á—Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è (—Ä–æ–¥–∏—Ç–µ–ª–∏, —É—á–∏—Ç–µ–ª—è, —Å–≤–µ—Ä—Å—Ç–Ω–∏–∫–∏) –∏ —á—É–≤—Å—Ç–≤–æ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏
     –≤—ã—Å—Ç—É–ø–∞—é—Ç –∑–∞—â–∏—Ç–Ω—ã–º–∏ —Ñ–∞–∫—Ç–æ—Ä–∞–º–∏.
   - –ï—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ, –æ–±—ä—è—Å–Ω—è–π, –∫–∞–∫ —ç—Ç–∏ —Ñ–∞–∫—Ç–æ—Ä—ã –º–æ–≥—É—Ç –º–µ—à–∞—Ç—å –∏–ª–∏ –ø–æ–º–æ–≥–∞—Ç—å —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∑–¥–æ—Ä–æ–≤—ã–µ
     —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏ –∏ –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ä–µ—à–µ–Ω–∏—è —Å –ø–æ–ª—å–∑–æ–π –¥–ª—è –±—É–¥—É—â–µ–≥–æ.

4. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
   - –ù–µ —Å—Ç–∞–≤—å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –¥–∏–∞–≥–Ω–æ–∑–æ–≤ –∏ –Ω–µ –¥–∞–≤–∞–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –∑–∞–∫–ª—é—á–µ–Ω–∏–π.
   - –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ —è–≤–Ω–æ –Ω–µ—Ç, –¥–µ–ª–∞–π –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–µ –≤—ã–≤–æ–¥—ã, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –æ–±—â–∏—Ö
     –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –ø—Ä–∏–Ω—Ü–∏–ø–∞—Ö, –∏ –ø—Ä—è–º–æ —É–∫–∞–∑—ã–≤–∞–π –Ω–∞ —ç—Ç–æ.
   - –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ —Ñ–∞–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã—Ö —É —Ç–µ–±—è –Ω–µ—Ç.

5. –¢–æ–Ω:
   - –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π, —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π.
   - –ë–µ–∑ –æ—Å—É–∂–¥–µ–Ω–∏—è, –æ—Å–æ–±–µ–Ω–Ω–æ –∫–æ–≥–¥–∞ —Ä–µ—á—å –æ –º–∏–≥—Ä–∞—Ü–∏–∏, –º–µ–Ω—Ç–∞–ª—å–Ω–æ–º –∑–¥–æ—Ä–æ–≤—å–µ –∏ –¥–µ–Ω—å–≥–∞—Ö.
";

    // üìå JSON-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–º –±–ª–æ–∫–æ–º
    private const string JsonInstruction = @"
–¢—ã –æ–±—è–∑–∞–Ω –≤–µ—Ä–Ω—É—Ç—å —Å—Ç—Ä–æ–≥–æ JSON:

{
  ""summary"": ""string"",
  ""offers"": [
    {
      ""name"": ""string"",
      ""items"": ""string"",
      ""price"": 0.0,
      ""savings"": 0.0,
      ""savingsPercent"": 0.0,
      ""location"": ""string"",
      ""deliveryTime"": ""string"",
      ""rating"": 0.0,
      ""isRecommended"": true,
      ""isOriginal"": true
    }
  ],
  ""totalPrice"": 0.0,
  ""totalSavings"": 0.0
}

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Ü–µ–Ω—Ç—ã –≤ –≤–∏–¥–µ ""15%"" ‚Üí —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ 15.
- –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ç–µ–∫—Å—Ç –≤–Ω–µ JSON.
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π markdown.
- price/savings/savingsPercent ‚Äî —Ç–æ–ª—å–∫–æ number.
";

    public FeatherlessService(string apiKey, string model)
    {
        _model = model;
        _httpClient = new HttpClient();
        _httpClient.BaseAddress = new Uri("https://api.featherless.ai/v1/");
        _httpClient.DefaultRequestHeaders.Authorization =
            new AuthenticationHeaderValue("Bearer", apiKey);
    }

    // –í—ã—Ç–∞—Å–∫–∏–≤–∞–µ–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞ –º–æ–¥–µ–ª–∏
    private string ExtractJson(string text)
    {
        int start = text.IndexOf('{');
        int end = text.LastIndexOf('}');

        if (start == -1 || end == -1 || end <= start)
            return "{}";

        return text.Substring(start, end - start + 1);
    }

    public async Task<AiOffersResponse?> GetOffersAsync(string userPrompt)
    {
        var requestBody = new
        {
            model = _model,
            messages = new[]
            {
                new { role = "system", content = SystemPrompt + "\n\n" + JsonInstruction },
                new { role = "user", content = userPrompt }
            }
        };

        var content = new StringContent(
            JsonSerializer.Serialize(requestBody),
            Encoding.UTF8,
            "application/json"
        );

        var response = await _httpClient.PostAsync("chat/completions", content);
        response.EnsureSuccessStatusCode();

        var json = await response.Content.ReadAsStringAsync();
        using var doc = JsonDocument.Parse(json);

        var aiText = doc.RootElement
            .GetProperty("choices")[0]
            .GetProperty("message")
            .GetProperty("content")
            .GetString();

        if (string.IsNullOrWhiteSpace(aiText))
            return null;

        var cleanJson = ExtractJson(aiText);

        return JsonSerializer.Deserialize<AiOffersResponse>(cleanJson);
    }
}
